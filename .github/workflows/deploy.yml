name: Deploy MVP to AWS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # --- PASO 1: LIMPIEZA DE EMERGENCIA ---
            echo "ðŸ§¹ Liberando espacio en disco..."
            
            # 1. Borrar la Swap (Ya no la necesitas en t3.medium y ocupa 2GB)
            if [ -f /swapfile ]; then
                sudo swapoff /swapfile || true
                sudo rm -f /swapfile
                echo "âœ… Swap eliminada (2GB recuperados)"
            fi

            # 2. Borrar contenedores, imÃ¡genes y redes viejas
            sudo docker system prune -af
            sudo docker volume prune -f
            
            # 3. Matar cualquier proceso rebelde (como el pgadmin que salÃ­a en el error)
            sudo docker rm -f mrteo-pgadmin || true

            # --- PASO 2: DESPLIEGUE ---
            DIR="/home/ubuntu/mr-teo-project"
            
            # Si la carpeta no existe, clonamos
            if [ ! -d "$DIR" ]; then
              git clone https://github.com/Kadumendez/IDAT_M06_PY.git $DIR
            else
              cd $DIR
              git reset --hard
              git pull origin main
            fi

            cd $DIR
            
            # Levantamos todo limpio
            echo "ðŸš€ Levantando proyecto..."
            sudo docker-compose down --remove-orphans || true
            sudo docker-compose up -d --build