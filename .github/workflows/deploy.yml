name: Deploy MVP to AWS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # --- PASO 0: ELECTROSHOCK (Reiniciar Cerebro Docker) ---
            echo "âš¡ Reiniciando servicio Docker para eliminar fantasmas..."
            sudo systemctl restart docker
            sleep 10  # Damos tiempo a que despierte

            # --- PASO 1: LIMPIEZA POST-REINICIO ---
            echo "ðŸ§¹ Limpiando zona..."
            # Ahora que reiniciamos, este comando sÃ­ funcionarÃ¡ sin errores
            sudo docker stop $(sudo docker ps -aq) || true
            sudo docker rm -f $(sudo docker ps -aq) || true
            sudo docker system prune -af --volumes

            # --- PASO 2: BORRÃ“N Y CUENTA NUEVA DE CÃ“DIGO ---
            DIR="/home/ubuntu/mr-teo-project"
            sudo rm -rf $DIR

            # --- PASO 3: RE-INSTALACIÃ“N ---
            echo "ðŸ“¥ Clonando cÃ³digo limpio..."
            git clone https://github.com/Kadumendez/IDAT_M06_PY.git $DIR
            cd $DIR
            
            # Permisos
            sudo chown -R ubuntu:ubuntu .

            # --- PASO 4: LEVANTAR ---
            echo "ðŸš€ Despegando..."
            sudo docker-compose up -d --build